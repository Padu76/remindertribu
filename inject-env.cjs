// inject-env.cjs
// Genera config.js per il client con variabili pubbliche.
// SOLO valori non sensibili (NEXT_PUBLIC_*). Nessun segreto qui.

const fs = require('fs');
const path = require('path');

function writeConfig() {
  const cwd = process.cwd();
  const target = path.join(cwd, 'config.js');

  // Firebase (public)
  const firebasePublic = {
    apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY || '',
    authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || '',
    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || '',
    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET || '',
    messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID || '',
    appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID || '',
    measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID || ''
  };

  const reminderDaysAhead = parseInt(process.env.NEXT_PUBLIC_REMINDER_DAYS_AHEAD || '7', 10);
  const whatsappApiBase = process.env.WHATSAPP_API_BASE || '';

  const cfg = `
/* AUTO-GENERATED BY inject-env.cjs */
window.AppConfig = Object.freeze({
  /* Compat legacy (se qualcosa usa ancora questa forma) */
  FIREBASE: ${JSON.stringify(firebasePublic, null, 2)},

  /* Forma attesa dal tuo assets/js/config/firebase.js */
  firebase: {
    enabled: ${Boolean(firebasePublic.apiKey && firebasePublic.projectId)},
    config: ${JSON.stringify(firebasePublic, null, 2)}
  },

  REMINDER_DAYS_AHEAD: ${Number.isFinite(reminderDaysAhead) ? reminderDaysAhead : 7},
  WHATSAPP_API_BASE: ${JSON.stringify(whatsappApiBase)},
  VERSION: ${JSON.stringify(process.env.VERCEL_GIT_COMMIT_SHA || 'dev')},
  BUILD_AT: ${JSON.stringify(new Date().toISOString())}
});
`;
  fs.writeFileSync(target, cfg, 'utf8');
  console.log('✅ Variabili public caricate.');
  console.log(`✅ Generato ${target}`);
}

writeConfig();
